// Generated by CoffeeScript 1.8.0
'use-strict';
var Backbone, Fun, WebSock, global, _, _ref,
  __hasProp = {}.hasOwnProperty,
  __extends = function(child, parent) { for (var key in parent) { if (__hasProp.call(parent, key)) child[key] = parent[key]; } function ctor() { this.constructor = child; } ctor.prototype = parent.prototype; child.prototype = new ctor(); child.__super__ = parent.prototype; return child; };

global = typeof exports !== "undefined" && exports !== null ? exports : this;

_ = (typeof exports !== 'undefined' ? require('underscore') : global)._;

Backbone = typeof exports !== 'undefined' ? require('backbone') : global.Backbone;

Fun = global.Fun = {};

Fun.getFunctionName = function(fun) {
  var n;
  if ((n = fun.toString().match(/function+\s{1,}([a-zA-Z_0-9]*)/)) != null) {
    return n[1];
  } else {
    return null;
  }
};

Fun.getConstructorName = function(fun) {
  var name;
  return fun.constructor.name || ((name = this.getFunctionName(fun.constructor)) != null ? name : null);
};

WebSock = global.WebSock != null ? global.WebSock : global.WebSock = {};

WebSock.Client = (function() {
  Client.prototype.__streamHandlers = {};

  function Client(__addr, __options) {
    this.__addr = __addr;
    this.__options = __options != null ? __options : {};
    _.extend(this, Backbone.Events);
    this.model = WebSock.SockData;
    if (!((this.__options.auto_connect != null) && this.__options.auto_connect === false)) {
      this.connect();
    }
  }

  Client.prototype.connect = function() {
    var opts, validationModel;
    validationModel = Backbone.Model.extend({
      defaults: {
        header: {
          sender_id: String,
          type: String,
          sntTime: Date,
          srvTime: Date,
          rcvTime: Date,
          size: Number
        },
        body: null
      },
      validate: function(o) {
        var key, _i, _len, _ref;
        if (o == null) {
          o = this.attributes;
        }
        if (o.header == null) {
          return "required part 'header' was not defined";
        }
        _ref = this.defaults.header;
        for (_i = 0, _len = _ref.length; _i < _len; _i++) {
          key = _ref[_i];
          if (o.header[key] == null) {
            return "required header " + key + " was not defined";
          }
        }
        if (typeof o.header.sender_id !== 'string') {
          return "wrong value for sender_id header";
        }
        if (typeof o.header.type !== 'string') {
          return "wrong value for type header";
        }
        if ((new Date(o.header.sntTime)).getTime() !== o.header.sntTime) {
          return "wrong value for sntTime header";
        }
        if ((new Date(o.header.srvTime)).getTime() !== o.header.srvTime) {
          return "wrong value for srvTime header";
        }
        if ((new Date(o.header.rcvTime)).getTime() !== o.header.rcvTime) {
          return "wrong value for rcvTime header";
        }
        if (!o.body) {
          return "required part 'body' was not defined";
        }
        if (!JSON.stringify(o.body === o.size)) {
          return "content size was invalid";
        }
      }
    });
    opts = {
      multiplex: true,
      reconnection: true,
      reconnectionDelay: 1000,
      reconnectionDelayMax: 5000,
      timeout: 20000
    };
    _.extend(opts, _.pick(this.__options, _.keys(opts)));
    this.socket = new SockJS("" + this.__addr);
    this.socket.onopen = (function(_this) {
      return function() {
        WebSock.SockData.__connection__ = _this;
        return _this.trigger('connected');
      };
    })(this);
    this.socket.onclose = ((function(_this) {
      return function() {
        return _this.trigger('disconnected');
      };
    })(this));
    this.socket.onmessage = (function(_this) {
      return function(msg) {
        return console.log(arguments);
      };
    })(this);
    return this;
  };

  Client.prototype.addStream = function(name, clazz) {
    var s;
    if ((s = this.__streamHandlers[name]) != null) {
      return s;
    }
    return this.__streamHandlers[name] = clazz;
  };

  Client.prototype.removeStream = function(name) {
    if (this.__streamHandlers[name] == null) {
      return null;
    }
    return delete this.__streamHandlers[name];
  };

  Client.prototype.getClientId = function() {
    var _ref, _ref1;
    if (((_ref = this.socket) != null ? (_ref1 = _ref.io) != null ? _ref1.engine : void 0 : void 0) == null) {
      return null;
    }
    return this.socket.io.engine.id;
  };

  return Client;

})();

WebSock.SockData = (function(_super) {
  __extends(SockData, _super);

  function SockData() {
    return SockData.__super__.constructor.apply(this, arguments);
  }

  SockData.prototype.header = {};

  SockData.prototype.initialize = function(attributes, options) {
    this.__type = Fun.getConstructorName(this);
    return SockData.__super__.initialize.call(this, attributes, options);
  };

  SockData.prototype.sync = function(mtd, mdl, opt) {
    var m, _base;
    if (opt == null) {
      opt = {};
    }
    m = {};
    if (opt.header != null) {
      _.extend(this.header, opt.header);
    }
    if (mtd === 'create') {
      if ((_base = this.header).type == null) {
        _base.type = this.__type;
      }
      m.header = _.extend(this.header, {
        sntTime: Date.now()
      });
      m.body = mdl.attributes;
      return SockData.__connection__.socket.send(JSON.stringify(m));
    }
  };

  SockData.prototype.getSenderId = function() {
    return this.header.sender_id || null;
  };

  SockData.prototype.getSentTime = function() {
    return this.header.sntTime || null;
  };

  SockData.prototype.getServedTime = function() {
    return this.header.srvTime || null;
  };

  SockData.prototype.getRecievedTime = function() {
    return this.header.rcvTime || null;
  };

  SockData.prototype.getSize = function() {
    return this.header.size || null;
  };

  SockData.prototype.setRoomId = function(id) {
    return this.header.room_id = id;
  };

  SockData.prototype.getRoomId = function() {
    return this.header.room_id;
  };

  SockData.prototype.parse = function(data) {
    data = JSON.parse.data.data;
    this.header = Object.freeze(data.header);
    return SockData.__super__.parse.call(data.body);
  };

  return SockData;

})(Backbone.Model);

WebSock.Message = (function(_super) {
  __extends(Message, _super);

  function Message() {
    return Message.__super__.constructor.apply(this, arguments);
  }

  Message.prototype.defaults = {
    text: ""
  };

  return Message;

})(WebSock.SockData);

WebSock.RoomMessage = (function(_super) {
  __extends(RoomMessage, _super);

  function RoomMessage() {
    return RoomMessage.__super__.constructor.apply(this, arguments);
  }

  RoomMessage.prototype.defaults = {
    room_id: null,
    status: "pending"
  };

  RoomMessage.prototype.validate = function(o) {
    if (!((o.room_id != null) || this.attributes.room_id)) {
      return "parameter 'room_id' must be set";
    }
  };

  RoomMessage.prototype.initialize = function(attrs, options) {
    if (options == null) {
      options = {};
    }
    if (options.room_id != null) {
      this.header.room_id = options.room_id;
    }
    return RoomMessage.__super__.initialize.apply(this, arguments);
  };

  return RoomMessage;

})(WebSock.SockData);

WebSock.CreateRoom = (function(_super) {
  __extends(CreateRoom, _super);

  function CreateRoom() {
    return CreateRoom.__super__.constructor.apply(this, arguments);
  }

  return CreateRoom;

})(WebSock.RoomMessage);

WebSock.ListRooms = (function(_super) {
  __extends(ListRooms, _super);

  function ListRooms() {
    return ListRooms.__super__.constructor.apply(this, arguments);
  }

  ListRooms.prototype.defaults = {
    rooms: []
  };

  return ListRooms;

})(WebSock.SockData);

WebSock.JoinRoom = (function(_super) {
  __extends(JoinRoom, _super);

  function JoinRoom() {
    return JoinRoom.__super__.constructor.apply(this, arguments);
  }

  JoinRoom.prototype.set = function(attrs, opts) {
    if (attrs.room_id != null) {
      this.header.room_id = attrs.room_id;
    }
    return JoinRoom.__super__.set.call(this, attrs, opts);
  };

  JoinRoom.prototype.sync = function(mtd, mdl, opts) {
    delete mdl.body;
    return JoinRoom.__super__.sync.call(this, mtd, mdl, opts);
  };

  return JoinRoom;

})(WebSock.RoomMessage);

WebSock.LeaveRoom = (function(_super) {
  __extends(LeaveRoom, _super);

  function LeaveRoom() {
    return LeaveRoom.__super__.constructor.apply(this, arguments);
  }

  return LeaveRoom;

})(WebSock.RoomMessage);

WebSock.StreamCollection = (function(_super) {
  __extends(StreamCollection, _super);

  function StreamCollection() {
    return StreamCollection.__super__.constructor.apply(this, arguments);
  }

  StreamCollection.prototype.model = WebSock.SockData;

  StreamCollection.prototype.fetch = function() {
    return false;
  };

  StreamCollection.prototype.sync = function() {
    return false;
  };

  StreamCollection.prototype._prepareModel = function(attrs, options) {
    var model;
    if (attrs instanceof Backbone.Model) {
      if (!attrs.collection) {
        attrs.collection = this;
      }
      return attrs;
    }
    options = options ? _.clone(options) : {};
    options.collection = this;
    model = new this.model(attrs.body, options);
    model.header = attrs.header != null ? Object.freeze(attrs.header) : {};
    if (!model.validationError) {
      return model;
    }
    this.trigger('invalid', this, model.validationError, options);
    return false;
  };

  StreamCollection.prototype.send = function(attrs, opts) {
    return this.create(attrs, opts);
  };

  StreamCollection.prototype.initialize = function() {
    var _client;
    if (arguments[0] instanceof WebSock.Client) {
      return _client = arguments[0];
    }
  };

  return StreamCollection;

})(Backbone.Collection);

if ((typeof module !== "undefined" && module !== null ? (_ref = module.exports) != null ? _ref.WebSock : void 0 : void 0) != null) {
  module.exports.init = function(sock, listeners) {
    if (listeners == null) {
      listeners = [];
    }
    return sock.on('connection', (function(_this) {
      return function(client) {
        var l, listener;
        client.on('data', function(data) {
          data = JSON.parse(data);
          data.header.srvTime = Date.now();
          data.header.sender_id = client.id;
          return client.write(JSON.stringify(data));
        });
        for (listener in listeners) {
          if (((l = client._events[listener]) != null) && typeof l === 'function') {
            client.removeListener(listener, l);
          }
          client.on(listener, listeners[listener]);
        }
        return client;
      };
    })(this));
  };
}
